<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="TFG_Projects_APP_Frontend.Pages.Tasks.TaskBoardPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:dtos="clr-namespace:TFG_Projects_APP_Frontend.Entities.Dtos.Users"
    xmlns:models="clr-namespace:TFG_Projects_APP_Frontend.Entities.Models"
    xmlns:pageModels="clr-namespace:TFG_Projects_APP_Frontend.PageModels"
    Title="TaskBoardPage"
    x:DataType="pageModels:Tasks.TaskBoardPageModel"
    NavigationPage.HasNavigationBar="False"
    Shell.NavBarIsVisible="False">
    <VerticalStackLayout Padding="20">
        <Button Command="{Binding CreateTaskSectionCommand}" Text="Create Task Section" />
        <StackLayout Orientation="Horizontal" Spacing="20">
            <CollectionView
                ItemsSource="{Binding TaskSections}"
                SelectedItem="{Binding SelectedTaskSection}"
                SelectionChangedCommand="{Binding TaskSectionSelectedCommand}"
                SelectionMode="Single">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Horizontal" Span="1" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:TaskSection">
                        <Border Padding="5">
                            <StackLayout Spacing="5">
                                <StackLayout Orientation="Horizontal">
                                    <Button
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:Tasks.TaskBoardPageModel}}, Path=MoveSectionLeftCommand}"
                                        CommandParameter="{Binding .}"
                                        Text="&lt;" />
                                    <Label Text="{Binding Title}" />
                                    <Button
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:Tasks.TaskBoardPageModel}}, Path=MoveSectionRightCommand}"
                                        CommandParameter="{Binding .}"
                                        Text="&gt;" />
                                </StackLayout>
                                <Button
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:Tasks.TaskBoardPageModel}}, Path=EditTaskSectionCommand}"
                                    CommandParameter="{Binding .}"
                                    Text="Edit" />
                                <Button
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:Tasks.TaskBoardPageModel}}, Path=TaskCreateCommand}"
                                    CommandParameter="{Binding .}"
                                    Text="Create Task" />
                                <ListView ItemsSource="{Binding Tasks}">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ProjectTask">
                                            <ViewCell>
                                                <Border
                                                    Margin="5"
                                                    Padding="10"
                                                    BackgroundColor="#f0f0f0">
                                                    <StackLayout>
                                                        <Label Text="{Binding Title}" />
                                                        <Label Text="{Binding Description}" />
                                                        <Button
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:Tasks.TaskBoardPageModel}}, Path=EditTaskCommand}"
                                                            CommandParameter="{Binding .}"
                                                            Text="Edit Task" />
                                                    </StackLayout>
                                                </Border>
                                            </ViewCell>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <VerticalStackLayout IsVisible="{Binding IsEditingTaskSection}">
                <Label FontSize="30" Text="Edit Task Section" />
                <Button Command="{Binding CloseEditingtTaskSectionCommand}" Text="X" />
                <Label FontSize="20" Text="Title:" />
                <Entry Placeholder="Enter section title" Text="{Binding EditingTaskSectionData.Title}" />
            </VerticalStackLayout>

            <VerticalStackLayout IsVisible="{Binding IsEditingTask}">
                <Label FontSize="30" Text="Edit task" />
                <Button Command="{Binding CloseEditingtTaskCommand}" Text="X" />
                <Label FontSize="20" Text="Title:" />
                <Entry Placeholder="Enter task title" Text="{Binding EditingTaskData.Title}" />
                <Label FontSize="20" Text="Description:" />
                <Editor
                    HeightRequest="100"
                    Placeholder="Enter task description"
                    Text="{Binding EditingTaskData.Description}" />
                <Label FontSize="20" Text="Assigned To:" />
                <Picker
                    Title="Assigned to:"
                    ItemDisplayBinding="{Binding Username}"
                    ItemsSource="{Binding Users}"
                    SelectedItem="{Binding EditingTaskData.UserAssigned}" />
                <Picker
                    Title="Priority"
                    ItemDisplayBinding="{Binding Name}"
                    ItemsSource="{Binding Priorities}"
                    SelectedItem="{Binding EditingTaskData.Priority}" />
                <Button Command="{Binding AddDependencyCommand}" Text="Add dependency" />
                <CollectionView
                    ItemsSource="{Binding PossibleDependencies}"
                    SelectedItems="{Binding DependenciesToRemove}"
                    SelectionMode="Multiple" />
                <Button Command="{Binding SaveTaskChangesCommand}" Text="Save Task" />
            </VerticalStackLayout>

        </StackLayout>
        <ActivityIndicator
            HeightRequest="50"
            HorizontalOptions="Center"
            IsRunning="{Binding IsLoading}"
            IsVisible="{Binding IsLoading}"
            VerticalOptions="Center"
            WidthRequest="50" />
    </VerticalStackLayout>
</ContentPage>